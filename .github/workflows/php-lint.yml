name: PHP Linting

on:
  push:
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Test the package itself using composer scripts
  lint-package:
    name: Lint Package
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          ini-values: memory_limit=1G
          coverage: none
          tools: cs2pr

      - name: Validate composer.json
        run: composer validate --strict

      - name: Install dependencies
        uses: ramsey/composer-install@v3
        with:
          custom-cache-suffix: $(date -u "+%Y-%m")

      - name: PHP Syntax Check
        run: composer run lint:php

      - name: PHPCS Check
        id: phpcs
        run: |
          composer run lint:phpcs -- --report=checkstyle --report-file=phpcs-report.xml || PHPCS_EXIT=$?
          composer run lint:phpcs || true
          exit ${PHPCS_EXIT:-0}

      - name: Show PHPCS results in PR
        if: always() && steps.phpcs.outcome == 'failure'
        run: cs2pr ./phpcs-report.xml || true

      - name: PHPStan Check
        run: composer run lint:phpstan

  # Validate action.yml syntax
  validate-action:
    name: Validate Action
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate action.yml
        run: |
          # Check action.yml exists and is valid YAML
          if [ ! -f action.yml ]; then
            echo "action.yml not found!"
            exit 1
          fi

          # Basic YAML validation using Python
          python3 -c "import yaml; yaml.safe_load(open('action.yml'))"
          echo "action.yml is valid YAML"

          # Check required fields
          if ! grep -q "^name:" action.yml; then
            echo "action.yml missing 'name' field"
            exit 1
          fi

          if ! grep -q "^runs:" action.yml; then
            echo "action.yml missing 'runs' field"
            exit 1
          fi

          echo "action.yml validation passed"
